<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Chifftown Chronicle ‚Äî Classic Newspaper</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Lora:wght@400;500;600;700&family=Old+Standard+TT:wght@400;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lora', serif;
            background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
            color: #1a1a1a;
            line-height: 1.6;
            padding: 2rem 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Navigation outside the paper */
        .nav-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(244, 197, 66, 0.3);
        }

        .nav-logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: #f4c542;
            text-decoration: none;
            letter-spacing: 1px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f0eef6;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            font-family: 'Lora', serif;
        }

        .back-btn:hover {
            background: rgba(244, 197, 66, 0.2);
            border-color: #f4c542;
        }

        /* Newspaper Container */
        .newspaper-wrapper {
            max-width: 1200px;
            margin: 5rem auto 2rem;
            perspective: 2000px;
            position: relative;
        }

        .newspaper-container {
            position: relative;
            width: 100%;
            background: #faf8f0;
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.1),
                0 8px 16px rgba(0, 0, 0, 0.1),
                0 16px 32px rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            overflow: hidden;
        }

        /* Paper texture overlay */
        .newspaper-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.02) 2px, rgba(0,0,0,.02) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,.02) 2px, rgba(0,0,0,.02) 4px);
            pointer-events: none;
            opacity: 0.3;
        }

        /* Yellowed edges effect */
        .newspaper-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            box-shadow: inset 0 0 80px rgba(210, 180, 140, 0.2);
            pointer-events: none;
        }

        /* Page container with flip animation */
        .page-container {
            position: relative;
            width: 100%;
            min-height: 1200px;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 3rem;
            opacity: 0;
            pointer-events: none;
            transform: rotateY(-90deg);
            transform-origin: left center;
            transition: all 0.8s cubic-bezier(0.645, 0.045, 0.355, 1);
        }

        .page.active {
            opacity: 1;
            pointer-events: auto;
            transform: rotateY(0deg);
            position: relative;
        }

        .page.flipped {
            opacity: 0;
            transform: rotateY(90deg);
            transform-origin: right center;
        }

        /* Center fold line */
        .page::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.1) 10%, rgba(0,0,0,0.1) 90%, transparent);
            transform: translateX(-50%);
        }

        /* Masthead */
        .masthead {
            text-align: center;
            padding: 2rem 0 1.5rem;
            border-top: 4px double #1a1a1a;
            border-bottom: 4px double #1a1a1a;
            margin-bottom: 2rem;
            position: relative;
        }

        .masthead::before,
        .masthead::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: #1a1a1a;
        }

        .masthead::before {
            top: 8px;
        }

        .masthead::after {
            bottom: 8px;
        }

        .masthead-title {
            font-family: 'Old Standard TT', serif;
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            font-weight: 700;
            color: #1a1a1a;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            line-height: 1;
        }

        .masthead-subtitle {
            font-family: 'Playfair Display', serif;
            font-size: 0.9rem;
            font-style: italic;
            color: #555;
            margin-bottom: 0.75rem;
        }

        .masthead-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #666;
            padding: 0 2rem;
            margin-top: 0.75rem;
        }

        .edition-info {
            font-weight: 600;
        }

        .price {
            font-weight: 700;
            background: #1a1a1a;
            color: #faf8f0;
            padding: 0.2rem 0.5rem;
            border-radius: 2px;
        }

        /* Column layout */
        .news-columns {
            column-count: 3;
            column-gap: 2rem;
            column-rule: 1px solid #ccc;
        }

        .news-columns-two {
            column-count: 2;
            column-gap: 2rem;
            column-rule: 1px solid #ccc;
        }

        /* Articles */
        .article {
            break-inside: avoid;
            margin-bottom: 1.5rem;
        }

        .article-category {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #c0392b;
            margin-bottom: 0.25rem;
        }

        .article-headline {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 900;
            line-height: 1.2;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
        }

        .article-headline.breaking {
            font-size: 2rem;
            border-bottom: 2px solid #1a1a1a;
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .article-subheadline {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            font-style: italic;
            font-weight: 400;
            color: #444;
            margin-bottom: 0.5rem;
        }

        .article-byline {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .article-body {
            font-size: 0.9rem;
            line-height: 1.7;
            color: #2a2a2a;
            text-align: justify;
        }

        /* Drop cap */
        .article-body.drop-cap::first-letter {
            float: left;
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            line-height: 0.9;
            margin: 0.1rem 0.1rem 0 0;
            font-weight: 700;
        }

        /* Breaking tag */
        .breaking-tag {
            display: inline-block;
            background: #c0392b;
            color: white;
            padding: 0.2rem 0.5rem;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        /* Gossip styling */
        .gossip-item {
            border-left: 3px solid #c0392b;
            padding-left: 0.75rem;
            margin-bottom: 1rem;
            break-inside: avoid;
        }

        .gossip-text {
            font-style: italic;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .gossip-attribution {
            font-size: 0.7rem;
            color: #666;
        }

        /* Leaderboard table */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            break-inside: avoid;
            font-size: 0.85rem;
        }

        .leaderboard-table th {
            background: #1a1a1a;
            color: #faf8f0;
            padding: 0.5rem;
            text-align: left;
            font-weight: 700;
            border: 1px solid #333;
        }

        .leaderboard-table td {
            padding: 0.4rem 0.5rem;
            border: 1px solid #ddd;
        }

        .leaderboard-table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.03);
        }

        /* Events listing */
        .event-item {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px dotted #ccc;
            break-inside: avoid;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .event-details {
            font-size: 0.8rem;
            color: #555;
        }

        /* Horoscope */
        .horoscope-item {
            margin-bottom: 0.75rem;
            break-inside: avoid;
        }

        .horoscope-sign {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .horoscope-text {
            font-size: 0.85rem;
            line-height: 1.5;
        }

        /* Page navigation */
        .page-navigation {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            z-index: 1000;
            background: rgba(26, 26, 46, 0.95);
            padding: 1rem 2rem;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .nav-btn {
            background: linear-gradient(135deg, #f4c542, #d4a532);
            border: none;
            color: #1a1a1a;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Lora', serif;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 197, 66, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #f4c542;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .page-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(244, 197, 66, 0.3);
            transition: all 0.3s ease;
        }

        .page-dot.active {
            background: #f4c542;
            transform: scale(1.3);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .news-columns {
                column-count: 2;
            }
        }

        @media (max-width: 600px) {
            .news-columns,
            .news-columns-two {
                column-count: 1;
                column-rule: none;
            }

            .page {
                padding: 1.5rem;
            }

            .masthead-title {
                font-size: 2rem;
            }

            .page-navigation {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem 1rem;
            }
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }

        /* Decorative elements */
        .ornament {
            text-align: center;
            margin: 1rem 0;
            color: #999;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <div class="nav-header">
        <a href="/" class="nav-logo">CHIFFTOWN</a>
        <a href="/" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Town
        </a>
    </div>

    <!-- Newspaper -->
    <div class="newspaper-wrapper">
        <div class="newspaper-container">
            <div class="page-container">
                <!-- Page 1: Front Page -->
                <div class="page active" id="page1">
                    <div class="masthead">
                        <h1 class="masthead-title">The Chifftown Chronicle</h1>
                        <p class="masthead-subtitle">"All the News That's Fit to Stream"</p>
                        <div class="masthead-meta">
                            <span class="edition-info" id="editionInfo">Loading...</span>
                            <span id="currentDate">Loading...</span>
                            <span class="price">FREE</span>
                        </div>
                    </div>

                    <div id="frontPageNews" class="news-columns">
                        <div class="loading">Loading today's top stories...</div>
                    </div>
                </div>

                <!-- Page 2: Gossip Column -->
                <div class="page" id="page2">
                    <div class="masthead">
                        <h1 class="masthead-title">The Chifftown Chronicle</h1>
                        <p class="masthead-subtitle">Page 2 ‚Äî Gossip & Whispers</p>
                    </div>

                    <div class="news-columns-two">
                        <div class="article">
                            <div class="article-category">üî• Hot Gossip</div>
                            <h2 class="article-headline">The Talk of the Town</h2>
                            <p class="article-subheadline">Our reporters have been listening...</p>
                            <div id="gossipColumn">
                                <div class="loading">Loading gossip...</div>
                            </div>
                        </div>

                        <div class="article">
                            <div class="article-category">üì¢ Submit Your Tip</div>
                            <h2 class="article-headline">Have a Secret?</h2>
                            <p class="article-body" style="margin-bottom: 1rem;">
                                Know something juicy? Share it anonymously! All submissions are 100% confidential.
                            </p>
                            <form id="gossipForm" style="background: rgba(0,0,0,0.02); padding: 1rem; border: 1px solid #ddd;">
                                <textarea 
                                    id="gossipInput" 
                                    placeholder="Spill the tea... (10-500 characters)"
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #ccc; font-family: 'Lora', serif; font-size: 0.85rem; min-height: 100px; resize: vertical;"
                                    maxlength="500"
                                ></textarea>
                                <div style="text-align: right; font-size: 0.7rem; color: #666; margin: 0.25rem 0;">
                                    <span id="charCount">0</span>/500
                                </div>
                                <button 
                                    type="submit" 
                                    style="width: 100%; background: #1a1a1a; color: #faf8f0; border: none; padding: 0.75rem; cursor: pointer; font-family: 'Lora', serif; font-weight: 700; font-size: 0.85rem;"
                                >
                                    Submit Anonymously
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Page 3: Leaderboards & Sports -->
                <div class="page" id="page3">
                    <div class="masthead">
                        <h1 class="masthead-title">The Chifftown Chronicle</h1>
                        <p class="masthead-subtitle">Page 3 ‚Äî Sports & Competition</p>
                    </div>

                    <div class="news-columns-two">
                        <div class="article">
                            <div class="article-category">üèÜ Top Citizens</div>
                            <h2 class="article-headline">The Leaderboard</h2>
                            <p class="article-subheadline">Who's dominating Chifftown?</p>
                            <div id="leaderboardSection">
                                <div class="loading">Loading leaderboard...</div>
                            </div>
                        </div>

                        <div class="article">
                            <div class="article-category">üéÆ Gaming News</div>
                            <h2 class="article-headline">Arcade Champions</h2>
                            <div id="hotTakesSection">
                                <div class="loading">Loading hot takes...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 4: Entertainment -->
                <div class="page" id="page4">
                    <div class="masthead">
                        <h1 class="masthead-title">The Chifftown Chronicle</h1>
                        <p class="masthead-subtitle">Page 4 ‚Äî Entertainment & Events</p>
                    </div>

                    <div class="news-columns-two">
                        <div class="article">
                            <div class="article-category">üé¨ Cinema</div>
                            <h2 class="article-headline">Now Showing</h2>
                            <p class="article-subheadline">Catch these films at the Chifftown Cinema</p>
                            <div id="showingsSection">
                                <div class="loading">Loading showings...</div>
                            </div>
                        </div>

                        <div class="article">
                            <div class="article-category">üéâ Events Calendar</div>
                            <h2 class="article-headline">Upcoming Events</h2>
                            <p class="article-subheadline">Don't miss out on the action!</p>
                            <div id="eventsSection">
                                <div class="loading">Loading events...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 5: Classifieds & Community -->
                <div class="page" id="page5">
                    <div class="masthead">
                        <h1 class="masthead-title">The Chifftown Chronicle</h1>
                        <p class="masthead-subtitle">Page 5 ‚Äî Community Corner</p>
                    </div>

                    <div class="news-columns">
                        <div class="article">
                            <div class="article-category">üèÖ Recent Achievements</div>
                            <h2 class="article-headline">Hall of Fame</h2>
                            <div id="achievementsSection">
                                <div class="loading">Loading achievements...</div>
                            </div>
                        </div>

                        <div class="article">
                            <div class="article-category">üë• New Residents</div>
                            <h2 class="article-headline">Welcome to Town!</h2>
                            <div id="newResidentsSection">
                                <div class="loading">Loading new residents...</div>
                            </div>
                        </div>

                        <div class="article">
                            <div class="article-category">üìä Town Statistics</div>
                            <h2 class="article-headline">By the Numbers</h2>
                            <div id="statsSection">
                                <div class="loading">Loading stats...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 6: Back Page - Fun Stuff -->
                <div class="page" id="page6">
                    <div class="masthead">
                        <h1 class="masthead-title">The Chifftown Chronicle</h1>
                        <p class="masthead-subtitle">Page 6 ‚Äî Horoscopes & Fun Facts</p>
                    </div>

                    <div class="news-columns-two">
                        <div class="article">
                            <div class="article-category">‚≠ê Daily Horoscopes</div>
                            <h2 class="article-headline">What the Stars Say</h2>
                            <p class="article-subheadline">Your daily fortune awaits...</p>
                            <div id="horoscopeSection">
                                <!-- Horoscopes will be generated -->
                            </div>
                        </div>

                        <div class="article">
                            <div class="article-category">üå§Ô∏è Weather Report</div>
                            <h2 class="article-headline">Virtual Forecast</h2>
                            <p class="article-body" style="margin-bottom: 1rem;">
                                Today's forecast: <strong>Partly cloudy with a 90% chance of epic moments.</strong> 
                                Perfect weather for exploring Chifftown's finest establishments!
                            </p>

                            <div class="ornament">‚ùã ‚ùã ‚ùã</div>

                            <div class="article-category">üí° Did You Know?</div>
                            <h2 class="article-headline">Chifftown Fun Facts</h2>
                            <div id="funFactsSection">
                                <!-- Fun facts will be generated -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Navigation -->
        <div class="page-navigation">
            <button class="nav-btn" id="prevBtn" onclick="changePage(-1)" disabled>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            <div class="page-indicator">
                <span class="page-dot active" data-page="1"></span>
                <span class="page-dot" data-page="2"></span>
                <span class="page-dot" data-page="3"></span>
                <span class="page-dot" data-page="4"></span>
                <span class="page-dot" data-page="5"></span>
                <span class="page-dot" data-page="6"></span>
            </div>
            <button class="nav-btn" id="nextBtn" onclick="changePage(1)">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let currentPage = 1;
        const totalPages = 6;

        // Page navigation
        function changePage(direction) {
            const oldPage = currentPage;
            currentPage = Math.max(1, Math.min(totalPages, currentPage + direction));
            
            if (oldPage !== currentPage) {
                // Remove active from old page
                const oldPageEl = document.getElementById(`page${oldPage}`);
                oldPageEl.classList.remove('active');
                if (direction > 0) {
                    oldPageEl.classList.add('flipped');
                } else {
                    oldPageEl.classList.remove('flipped');
                }

                // Activate new page
                setTimeout(() => {
                    const newPageEl = document.getElementById(`page${currentPage}`);
                    newPageEl.classList.add('active');
                    newPageEl.classList.remove('flipped');
                    
                    // Update navigation
                    updateNavigation();
                }, 100);
            }
        }

        function updateNavigation() {
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
            
            // Update page dots
            document.querySelectorAll('.page-dot').forEach((dot, index) => {
                dot.classList.toggle('active', index + 1 === currentPage);
            });
        }

        // Date setup
        const now = new Date();
        document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Load edition
        async function loadEdition() {
            try {
                const res = await fetch('/api/edition');
                const edition = await res.json();
                document.getElementById('editionInfo').textContent = 
                    `Vol. ${edition.volume}, Issue ${edition.issue}`;
            } catch (error) {
                console.error('Error loading edition:', error);
                document.getElementById('editionInfo').textContent = 'Vol. 1, Issue 1';
            }
        }

        // Character counter for gossip
        const gossipInput = document.getElementById('gossipInput');
        if (gossipInput) {
            gossipInput.addEventListener('input', (e) => {
                document.getElementById('charCount').textContent = e.target.value.length;
            });
        }

        // Submit gossip
        document.getElementById('gossipForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const tip = gossipInput.value.trim();
            if (tip.length < 10 || tip.length > 500) {
                alert('Tip must be between 10-500 characters');
                return;
            }
            
            try {
                const response = await fetch('/api/gossip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tip })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Your tip has been submitted anonymously!');
                    gossipInput.value = '';
                    document.getElementById('charCount').textContent = '0';
                    loadGossip();
                } else {
                    alert('Failed to submit tip. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting gossip:', error);
                alert('Failed to submit tip. Please try again.');
            }
        });

        // Load front page news
        async function loadFrontPage() {
            try {
                const res = await fetch('/api/activity?limit=100');
                const activity = await res.json();
                
                const newsHTML = generateFrontPageNews(activity);
                document.getElementById('frontPageNews').innerHTML = newsHTML;
            } catch (error) {
                console.error('Error loading front page:', error);
                document.getElementById('frontPageNews').innerHTML = 
                    '<p class="loading">Failed to load news.</p>';
            }
        }

        function generateFrontPageNews(activity) {
            let html = '';
            
            // Find the most notable event for breaking news
            const levelUps = activity.filter(a => a.type === 'level_up');
            const bigLevelUp = levelUps.find(a => a.level >= 10);
            
            if (bigLevelUp) {
                html += `
                    <div class="article">
                        <div class="breaking-tag">BREAKING NEWS</div>
                        <h2 class="article-headline breaking">${escapeHtml(bigLevelUp.username)} Reaches Level ${bigLevelUp.level}!</h2>
                        <p class="article-subheadline">A milestone achievement for one of Chifftown's most dedicated residents</p>
                        <div class="article-byline">By Chifftown Chronicle Staff ‚Ä¢ ${formatTime(bigLevelUp.timestamp)}</div>
                        <p class="article-body drop-cap">
                            In what can only be described as a remarkable display of dedication, ${escapeHtml(bigLevelUp.username)} 
                            has officially reached Level ${bigLevelUp.level}, marking a significant milestone in their Chifftown journey. 
                            Sources close to the matter report that they've been spotted frequenting the town's most popular venues, 
                            from the bustling Arcade to the sophisticated Nightclub. When asked for comment, witnesses described their 
                            determination as "inspiring" and "slightly concerning." The achievement has sent ripples through the 
                            community, with many wondering: who will be next to join the elite ranks?
                        </p>
                    </div>
                `;
            }
            
            // Recent achievements
            const achievements = activity.filter(a => a.type === 'achievement').slice(0, 2);
            achievements.forEach(ach => {
                html += `
                    <div class="article">
                        <div class="article-category">Achievement Unlocked</div>
                        <h2 class="article-headline">${escapeHtml(ach.username)} Earns "${escapeHtml(ach.achievementName)}"</h2>
                        <div class="article-byline">Achievement Desk ‚Ä¢ ${formatTime(ach.timestamp)}</div>
                        <p class="article-body">
                            The streets of Chifftown are buzzing with news of ${escapeHtml(ach.username)}'s latest accomplishment. 
                            The coveted "${escapeHtml(ach.achievementName)}" badge now adorns their profile, a testament to their 
                            skill and perseverance. Fellow residents have been quick to offer congratulations, though some admit to 
                            feeling a twinge of envy. As one anonymous source put it: "They make it look easy, but we all know the 
                            grind behind the glory."
                        </p>
                    </div>
                `;
            });
            
            // Activity summary
            const today = new Date().setHours(0, 0, 0, 0);
            const todayActivity = activity.filter(a => new Date(a.timestamp).setHours(0, 0, 0, 0) === today);
            const uniqueUsers = new Set(todayActivity.map(a => a.username));
            
            html += `
                <div class="article">
                    <div class="article-category">Town Report</div>
                    <h2 class="article-headline">Chifftown Sees Record Activity</h2>
                    <div class="article-byline">Community Desk ‚Ä¢ Today</div>
                    <p class="article-body">
                        Chifftown continues its streak of vibrant activity, with ${uniqueUsers.size} residents 
                        actively participating in today's events. From casino wins to arcade high scores, the virtual 
                        municipality shows no signs of slowing down. Local business owners report steady foot traffic, 
                        with the Pub and Nightclub seeing particularly strong attendance during evening hours.
                    </p>
                </div>
            `;
            
            // More recent activity
            const recentEvents = activity.slice(0, 5);
            html += `
                <div class="article">
                    <div class="article-category">Recent Activity</div>
                    <h2 class="article-headline">Around Town</h2>
                    <div class="article-body">
            `;
            
            recentEvents.forEach(event => {
                let description = '';
                if (event.type === 'level_up') {
                    description = `<strong>${escapeHtml(event.username)}</strong> advanced to Level ${event.level}.`;
                } else if (event.type === 'achievement') {
                    description = `<strong>${escapeHtml(event.username)}</strong> unlocked "${escapeHtml(event.achievementName)}".`;
                } else if (event.type === 'venue_visit') {
                    description = `<strong>${escapeHtml(event.username)}</strong> visited the ${escapeHtml(event.venue)}.`;
                }
                
                html += `<p style="margin-bottom: 0.5rem;">‚ñ™ ${description}</p>`;
            });
            
            html += `</div></div>`;
            
            return html;
        }

        // Load gossip
        async function loadGossip() {
            try {
                const res = await fetch('/api/gossip?limit=15');
                const tips = await res.json();
                
                let html = '';
                if (tips.length === 0) {
                    html = '<p class="gossip-text" style="text-align: center; color: #999;">No gossip yet. Be the first to spill the tea!</p>';
                } else {
                    tips.forEach(tip => {
                        html += `
                            <div class="gossip-item">
                                <p class="gossip-text">"${escapeHtml(tip.tip)}"</p>
                                <p class="gossip-attribution">‚Äî ${escapeHtml(tip.author)}, ${formatTime(tip.timestamp)}</p>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('gossipColumn').innerHTML = html;
            } catch (error) {
                console.error('Error loading gossip:', error);
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const res = await fetch('/api/leaderboard?limit=10');
                const players = await res.json();
                
                let html = '<table class="leaderboard-table">';
                html += '<tr><th>Rank</th><th>Player</th><th>Level</th><th>XP</th></tr>';
                
                players.forEach((player, index) => {
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                    html += `
                        <tr>
                            <td>${medal} ${index + 1}</td>
                            <td>${escapeHtml(player.username)}</td>
                            <td>${player.level}</td>
                            <td>${player.xp.toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                document.getElementById('leaderboardSection').innerHTML = html;
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Load hot takes
        async function loadHotTakes() {
            try {
                const res = await fetch('/api/hot-takes');
                const hotTakes = await res.json();
                
                let html = '';
                if (hotTakes.length === 0) {
                    html = '<p style="text-align: center; color: #999; font-style: italic;">No gaming data yet.</p>';
                } else {
                    hotTakes.slice(0, 5).forEach(take => {
                        html += `
                            <div class="event-item">
                                <div class="event-title">${take.title}</div>
                                <div class="event-details">
                                    üèÜ <strong>${escapeHtml(take.winner)}</strong><br>
                                    ${escapeHtml(take.stat)}<br>
                                    <em>${take.desc}</em>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('hotTakesSection').innerHTML = html;
            } catch (error) {
                console.error('Error loading hot takes:', error);
            }
        }

        // Load showings
        async function loadShowings() {
            try {
                const res = await fetch('/api/showings');
                const showings = await res.json();
                
                let html = '';
                if (showings.length === 0) {
                    html = '<p style="text-align: center; color: #999; font-style: italic;">No showings scheduled.</p>';
                } else {
                    showings.slice(0, 6).forEach(showing => {
                        html += `
                            <div class="event-item">
                                <div class="event-title">üé¨ ${escapeHtml(showing.title)}</div>
                                <div class="event-details">
                                    ${showing.time ? `Showtime: ${escapeHtml(showing.time)}` : 'Check cinema for times'}<br>
                                    ${showing.description ? escapeHtml(showing.description) : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('showingsSection').innerHTML = html;
            } catch (error) {
                console.error('Error loading showings:', error);
                document.getElementById('showingsSection').innerHTML = 
                    '<p style="text-align: center; color: #999; font-style: italic;">Check the cinema for current showings.</p>';
            }
        }

        // Load events
        async function loadEvents() {
            try {
                const res = await fetch('/api/events');
                const events = await res.json();
                
                let html = '';
                if (events.length === 0) {
                    html = '<p style="text-align: center; color: #999; font-style: italic;">No upcoming events.</p>';
                } else {
                    events.slice(0, 6).forEach(event => {
                        html += `
                            <div class="event-item">
                                <div class="event-title">üéâ ${escapeHtml(event.name)}</div>
                                <div class="event-details">
                                    ${event.date ? `Date: ${escapeHtml(event.date)}` : ''}<br>
                                    ${event.description ? escapeHtml(event.description) : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('eventsSection').innerHTML = html;
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('eventsSection').innerHTML = 
                    '<p style="text-align: center; color: #999; font-style: italic;">Stay tuned for upcoming events!</p>';
            }
        }

        // Load achievements
        async function loadAchievements() {
            try {
                const res = await fetch('/api/activity?limit=50');
                const activity = await res.json();
                const achievements = activity.filter(a => a.type === 'achievement').slice(0, 10);
                
                let html = '';
                if (achievements.length === 0) {
                    html = '<p style="text-align: center; color: #999; font-style: italic;">No achievements yet.</p>';
                } else {
                    achievements.forEach(ach => {
                        html += `
                            <div class="event-item">
                                <div class="event-title">üèÜ ${escapeHtml(ach.achievementName)}</div>
                                <div class="event-details">
                                    Earned by <strong>${escapeHtml(ach.username)}</strong><br>
                                    ${formatTime(ach.timestamp)}
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('achievementsSection').innerHTML = html;
            } catch (error) {
                console.error('Error loading achievements:', error);
            }
        }

        // Load new residents
        async function loadNewResidents() {
            try {
                const res = await fetch('/api/activity?limit=100');
                const activity = await res.json();
                
                // Get unique users from recent activity
                const users = [...new Set(activity.map(a => a.username))].slice(0, 8);
                
                let html = '';
                users.forEach(username => {
                    html += `
                        <div class="event-item">
                            <div class="event-title">üëã ${escapeHtml(username)}</div>
                            <div class="event-details">Recently active in Chifftown</div>
                        </div>
                    `;
                });
                
                document.getElementById('newResidentsSection').innerHTML = html;
            } catch (error) {
                console.error('Error loading residents:', error);
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const [activityRes, leaderboardRes] = await Promise.all([
                    fetch('/api/activity?limit=200'),
                    fetch('/api/leaderboard?limit=20')
                ]);
                
                const activity = await activityRes.json();
                const leaderboard = await leaderboardRes.json();
                
                const uniqueUsers = new Set(activity.map(a => a.username));
                const levelUps = activity.filter(a => a.type === 'level_up');
                const achievements = activity.filter(a => a.type === 'achievement');
                
                const today = new Date().setHours(0, 0, 0, 0);
                const todayActivity = activity.filter(a => new Date(a.timestamp).setHours(0, 0, 0, 0) === today);
                const activeToday = new Set(todayActivity.map(a => a.username));
                
                const html = `
                    <table class="leaderboard-table">
                        <tr><th>Metric</th><th>Count</th></tr>
                        <tr><td>Total Residents</td><td>${uniqueUsers.size}</td></tr>
                        <tr><td>Active Today</td><td>${activeToday.size}</td></tr>
                        <tr><td>Levels Gained</td><td>${levelUps.length}</td></tr>
                        <tr><td>Achievements</td><td>${achievements.length}</td></tr>
                        <tr><td>Total Events</td><td>${activity.length}</td></tr>
                    </table>
                `;
                
                document.getElementById('statsSection').innerHTML = html;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Generate horoscopes
        function generateHoroscopes() {
            const signs = [
                { name: 'Aries', advice: 'Your competitive spirit will serve you well at the Arcade today. Challenge accepted!' },
                { name: 'Taurus', advice: 'The Casino calls your name. Lady Luck is feeling generous... or is she?' },
                { name: 'Gemini', advice: 'Social connections bloom at the Pub. Strike up a conversation with a stranger!' },
                { name: 'Cancer', advice: 'Home is where the heart is. Maybe redecorate your apartment?' },
                { name: 'Leo', advice: 'The Nightclub spotlight awaits. Time to show off those dance moves!' },
                { name: 'Virgo', advice: 'Organization is key. Consider making a to-do list... then promptly ignore it.' },
                { name: 'Libra', advice: 'Balance work and play today. But mostly play. This is Chifftown, after all.' },
                { name: 'Scorpio', advice: 'Mystery surrounds you. Perhaps it\'s time to submit an anonymous gossip tip?' },
                { name: 'Sagittarius', advice: 'Adventure calls! Explore a venue you haven\'t visited in a while.' },
                { name: 'Capricorn', advice: 'Climb that XP mountain. Your dedication will be rewarded with sweet, sweet levels.' },
                { name: 'Aquarius', advice: 'Think outside the box today. Or inside the box. Boxes are nice too.' },
                { name: 'Pisces', advice: 'Let your imagination run wild. Reality is overrated anyway.' }
            ];
            
            let html = '';
            signs.forEach(sign => {
                html += `
                    <div class="horoscope-item">
                        <div class="horoscope-sign">‚≠ê ${sign.name}</div>
                        <div class="horoscope-text">${sign.advice}</div>
                    </div>
                `;
            });
            
            document.getElementById('horoscopeSection').innerHTML = html;
        }

        // Generate fun facts
        function generateFunFacts() {
            const facts = [
                'The Chifftown Pub has served over 1,000 virtual drinks since opening!',
                'Our Arcade features more games than you can shake a joystick at.',
                'The Casino\'s house edge is exactly what you\'d expect. Spoiler: the house wins.',
                'Local legend says the Nightclub\'s DJ never sleeps. We\'re starting to believe it.',
                'Chifftown residents have collectively gained over 500 levels!',
                'The Cinema has the comfiest virtual seats in the entire metaverse.',
                'Scientists confirm: XP is scientifically proven to make you feel good.',
                'Gossip travels faster in Chifftown than anywhere else. We have the metrics.'
            ];
            
            let html = '<div class="article-body">';
            // Pick 4 random facts
            const shuffled = facts.sort(() => 0.5 - Math.random());
            shuffled.slice(0, 4).forEach(fact => {
                html += `<p style="margin-bottom: 0.75rem;">üí° ${fact}</p>`;
            });
            html += '</div>';
            
            document.getElementById('funFactsSection').innerHTML = html;
        }

        // Utility functions
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            return 'Just now';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load all data
        loadEdition();
        loadFrontPage();
        loadGossip();
        loadLeaderboard();
        loadHotTakes();
        loadShowings();
        loadEvents();
        loadAchievements();
        loadNewResidents();
        loadStats();
        generateHoroscopes();
        generateFunFacts();

        // Setup real-time updates
        const socket = io();
        socket.on('new-gossip', () => loadGossip());
        socket.on('activity-update', () => {
            loadFrontPage();
            loadLeaderboard();
            loadAchievements();
            loadStats();
        });

        // Refresh data periodically
        setInterval(() => {
            loadFrontPage();
            loadGossip();
            loadLeaderboard();
            loadHotTakes();
        }, 5 * 60 * 1000); // Every 5 minutes
    </script>
    
    <!-- ChiffTown Share Button -->
    <script src="/js/share-button.js" data-share-message="Check out The Chifftown Chronicle! üì∞"></script>
</body>
</html>
