<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pub Stream - Chiffly</title>
    <link rel="stylesheet" href="main-home-styles.css?v=5">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #1a1a1a;
            color: white;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .stream-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            gap: 1rem;
            padding: 1rem;
        }

        .stream-header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pub-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .pub-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .pub-details h2 {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
        }

        .pub-details p {
            margin: 0;
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .stream-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .theme-selector {
            display: flex;
            gap: 0.5rem;
            margin-right: 1rem;
            padding-right: 1rem;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .theme-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .theme-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .theme-btn.active {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            border-color: #ed8936;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .control-btn.active {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .control-btn.danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .main-video-area {
            background: #2d3748;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .host-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: linear-gradient(135deg, #2d3748, #1a202c);
        }

        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2d3748, #1a202c);
            color: white;
        }

        .video-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .video-placeholder h3 {
            margin: 0 0 0.5rem 0;
            font-family: 'Poppins', sans-serif;
        }

        .video-placeholder p {
            margin: 0;
            opacity: 0.7;
            text-align: center;
        }

        .live-indicator {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: #e53e3e;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .live-indicator.active {
            display: flex;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .chat-area {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-header h3 {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #ed8936;
        }

        .message-author {
            font-weight: 600;
            color: #ed8936;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .message-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.5;
            margin-top: 0.25rem;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            border: none;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
        }

        .participants-area {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
        }

        .participants-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .participants-header h3 {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
        }

        .participant-slot {
            aspect-ratio: 16/9;
            background: #2d3748;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .participant-slot:hover {
            border-color: #ed8936;
        }

        .participant-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .participant-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2d3748, #1a202c);
            color: rgba(255, 255, 255, 0.5);
        }

        .participant-placeholder i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .participant-placeholder span {
            font-size: 0.8rem;
        }

        .participant-name {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            text-align: center;
            font-weight: 500;
        }

        .back-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 1024px) {
            .stream-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto auto;
            }

            .chat-area {
                order: 3;
                max-height: 300px;
            }

            .participants-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stream-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto auto;
                gap: 0.5rem;
                padding: 0.5rem;
            }

            .stream-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .stream-controls {
                flex-wrap: wrap;
                gap: 0.5rem;
                justify-content: center;
            }

            .control-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                min-width: 80px;
            }

            .control-btn span {
                display: none;
            }

            .control-btn i {
                margin: 0;
            }

            .theme-selector {
                order: -1;
                width: 100%;
                justify-content: center;
                margin: 0;
                padding: 0;
                border: none;
            }

            .theme-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }

            .chat-area {
                order: 3;
            }

            .participants-area {
                order: 4;
            }

            /* Show camera switch button on mobile when camera is on */
            #switchCameraBtn {
                background: rgba(255, 255, 255, 0.15);
                border-color: rgba(255, 255, 255, 0.3);
            }

            #switchCameraBtn:hover {
                background: rgba(255, 255, 255, 0.25);
            }
        }

        @media (max-width: 480px) {
            .stream-container {
                padding: 0.25rem;
                gap: 0.25rem;
            }

            .stream-header {
                padding: 0.75rem;
            }

            .pub-details h2 {
                font-size: 1.2rem;
            }

            .pub-details p {
                font-size: 0.8rem;
            }

            .control-btn {
                padding: 0.4rem 0.6rem;
                min-width: 60px;
            }

            .theme-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
            }
        }

        /* Cyberpunk Theme */
        body.cyberpunk {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0033 50%, #000a1a 100%);
        }

        body.cyberpunk .stream-header {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }

        body.cyberpunk .pub-icon {
            background: linear-gradient(135deg, #00ffff, #ff00ff);
        }

        body.cyberpunk .control-btn.active {
            background: linear-gradient(135deg, #00ffff, #ff00ff);
        }

        body.cyberpunk .theme-btn.active {
            background: linear-gradient(135deg, #00ffff, #ff00ff);
        }

        body.cyberpunk .main-video-area {
            border: 2px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
        }

        body.cyberpunk .video-placeholder {
            background: linear-gradient(135deg, #001122, #002244);
        }

        body.cyberpunk .chat-area {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        body.cyberpunk .chat-message {
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #00ffff;
        }

        body.cyberpunk .message-author {
            color: #00ffff;
        }

        body.cyberpunk .chat-send-btn {
            background: linear-gradient(135deg, #00ffff, #ff00ff);
        }

        body.cyberpunk .participants-area {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        body.cyberpunk .participant-slot {
            border: 2px solid rgba(0, 255, 255, 0.2);
        }

        body.cyberpunk .participant-slot:hover {
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        body.cyberpunk .participant-placeholder {
            background: linear-gradient(135deg, #001122, #002244);
        }

        /* Medieval Theme */
        body.medieval {
            background: linear-gradient(135deg, #2d1810 0%, #4a2c17 50%, #1a0f08 100%);
        }

        body.medieval .stream-header {
            background: rgba(139, 69, 19, 0.3);
            border: 1px solid rgba(218, 165, 32, 0.5);
            box-shadow: 0 0 20px rgba(218, 165, 32, 0.2);
        }

        body.medieval .pub-icon {
            background: linear-gradient(135deg, #daa520, #b8860b);
        }

        body.medieval .control-btn.active {
            background: linear-gradient(135deg, #daa520, #b8860b);
        }

        body.medieval .theme-btn.active {
            background: linear-gradient(135deg, #daa520, #b8860b);
        }

        body.medieval .main-video-area {
            border: 2px solid rgba(218, 165, 32, 0.4);
            box-shadow: 0 0 30px rgba(218, 165, 32, 0.2);
        }

        body.medieval .video-placeholder {
            background: linear-gradient(135deg, #3d2817, #2d1810);
        }

        body.medieval .chat-area {
            background: rgba(139, 69, 19, 0.2);
            border: 1px solid rgba(218, 165, 32, 0.3);
        }

        body.medieval .chat-message {
            background: rgba(139, 69, 19, 0.3);
            border-left: 3px solid #daa520;
        }

        body.medieval .message-author {
            color: #daa520;
        }

        body.medieval .chat-send-btn {
            background: linear-gradient(135deg, #daa520, #b8860b);
        }

        body.medieval .participants-area {
            background: rgba(139, 69, 19, 0.2);
            border: 1px solid rgba(218, 165, 32, 0.3);
        }

        body.medieval .participant-slot {
            border: 2px solid rgba(218, 165, 32, 0.3);
        }

        body.medieval .participant-slot:hover {
            border-color: #daa520;
            box-shadow: 0 0 15px rgba(218, 165, 32, 0.3);
        }

        body.medieval .participant-placeholder {
            background: linear-gradient(135deg, #3d2817, #2d1810);
        }

        /* Beach Bar Theme */
        body.beach {
            background: linear-gradient(135deg, #87ceeb 0%, #20b2aa 30%, #f0e68c 70%, #daa520 100%);
        }

        body.beach .stream-header {
            background: rgba(32, 178, 170, 0.3);
            border: 1px solid rgba(135, 206, 235, 0.5);
            box-shadow: 0 0 20px rgba(135, 206, 235, 0.3);
        }

        body.beach .pub-icon {
            background: linear-gradient(135deg, #20b2aa, #87ceeb);
        }

        body.beach .control-btn.active {
            background: linear-gradient(135deg, #20b2aa, #87ceeb);
        }

        body.beach .theme-btn.active {
            background: linear-gradient(135deg, #20b2aa, #87ceeb);
        }

        body.beach .main-video-area {
            border: 2px solid rgba(135, 206, 235, 0.5);
            box-shadow: 0 0 30px rgba(135, 206, 235, 0.3);
        }

        body.beach .video-placeholder {
            background: linear-gradient(135deg, #4682b4, #20b2aa);
        }

        body.beach .chat-area {
            background: rgba(135, 206, 235, 0.2);
            border: 1px solid rgba(32, 178, 170, 0.4);
        }

        body.beach .chat-message {
            background: rgba(135, 206, 235, 0.3);
            border-left: 3px solid #20b2aa;
        }

        body.beach .message-author {
            color: #20b2aa;
        }

        body.beach .chat-send-btn {
            background: linear-gradient(135deg, #20b2aa, #87ceeb);
        }

        body.beach .participants-area {
            background: rgba(135, 206, 235, 0.2);
            border: 1px solid rgba(32, 178, 170, 0.4);
        }

        body.beach .participant-slot {
            border: 2px solid rgba(135, 206, 235, 0.4);
        }

        body.beach .participant-slot:hover {
            border-color: #20b2aa;
            box-shadow: 0 0 15px rgba(32, 178, 170, 0.4);
        }

        body.beach .participant-placeholder {
            background: linear-gradient(135deg, #4682b4, #20b2aa);
        }

        /* Beach theme decorative elements */
        body.beach::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="sun" cx="80%" cy="20%"><stop offset="0%" stop-color="%23ffd700" stop-opacity="0.3"/><stop offset="100%" stop-color="%23ffd700" stop-opacity="0"/></radialGradient></defs><circle cx="800" cy="200" r="100" fill="url(%23sun)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        /* Cyberpunk decorative elements */
        body.cyberpunk::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><linearGradient id="neon" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="%2300ffff" stop-opacity="0.1"/><stop offset="50%" stop-color="%23ff00ff" stop-opacity="0.1"/><stop offset="100%" stop-color="%2300ffff" stop-opacity="0.1"/></linearGradient></defs><rect x="0" y="0" width="100" height="1000" fill="url(%23neon)"/><rect x="200" y="0" width="50" height="1000" fill="url(%23neon)"/><rect x="400" y="0" width="75" height="1000" fill="url(%23neon)"/></svg>');
            pointer-events: none;
            z-index: -1;
            animation: cyberpunkGlow 3s ease-in-out infinite alternate;
        }

        /* Medieval decorative elements */
        body.medieval::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="torch" cx="50%" cy="50%"><stop offset="0%" stop-color="%23daa520" stop-opacity="0.2"/><stop offset="100%" stop-color="%23daa520" stop-opacity="0"/></radialGradient></defs><circle cx="100" cy="100" r="80" fill="url(%23torch)"/><circle cx="900" cy="200" r="60" fill="url(%23torch)"/><circle cx="200" cy="800" r="70" fill="url(%23torch)"/></svg>');
            pointer-events: none;
            z-index: -1;
            animation: torchFlicker 2s ease-in-out infinite alternate;
        }

        @keyframes cyberpunkGlow {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes torchFlicker {
            0% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Back Button -->
    <button class="back-btn" onclick="window.location.href='pub.html'">
        <i class="fas fa-arrow-left"></i>
    </button>

    <div class="stream-container">
        <!-- Header -->
        <div class="stream-header">
            <div class="pub-info">
                <div class="pub-icon">
                    <i class="fas fa-wine-glass"></i>
                </div>
                <div class="pub-details">
                    <h2 id="pubName">My Cozy Pub</h2>
                    <p id="pubDescription">Welcome to our virtual pub! Grab a drink and chat.</p>
                </div>
            </div>
            <div class="stream-controls">
                <div class="theme-selector">
                    <button class="theme-btn active" onclick="setTheme('default')">Default</button>
                    <button class="theme-btn" onclick="setTheme('cyberpunk')">Cyberpunk</button>
                    <button class="theme-btn" onclick="setTheme('medieval')">Medieval</button>
                    <button class="theme-btn" onclick="setTheme('beach')">Beach Bar</button>
                </div>
                <button class="control-btn" id="micBtn" onclick="toggleMic()">
                    <i class="fas fa-microphone"></i>
                    <span>Mic</span>
                </button>
                <button class="control-btn" id="cameraBtn" onclick="toggleCamera()">
                    <i class="fas fa-video"></i>
                    <span>Camera</span>
                </button>
                <button class="control-btn" id="switchCameraBtn" onclick="switchCamera()" style="display: none;">
                    <i class="fas fa-sync-alt"></i>
                    <span>Back Cam</span>
                </button>
                <button class="control-btn" id="startStreamBtn" onclick="startStream()">
                    <i class="fas fa-broadcast-tower"></i>
                    <span>Start Stream</span>
                </button>
                <button class="control-btn danger" onclick="leavePub()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Leave</span>
                </button>
            </div>
        </div>

        <!-- Main Video Area -->
        <div class="main-video-area">
            <video id="hostVideo" class="host-video" autoplay muted playsinline style="display: none;"></video>
            <div class="video-placeholder" id="videoPlaceholder">
                <i class="fas fa-video-slash"></i>
                <h3>Camera Off</h3>
                <p>Click "Camera" to start your video stream</p>
            </div>
            <div class="live-indicator" id="liveIndicator">
                <div class="live-dot"></div>
                LIVE
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <i class="fas fa-comments"></i>
                <h3>Pub Chat</h3>
                <span id="userCount">(1 person)</span>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message">
                    <div class="message-author">System</div>
                    <div class="message-text">Welcome to the pub! Start chatting with other patrons.</div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
            <div class="chat-input-area">
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." maxlength="500">
                    <button class="chat-send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Participants Area -->
        <div class="participants-area">
            <div class="participants-header">
                <i class="fas fa-users"></i>
                <h3>Participants</h3>
                <span id="participantCount">(0/6 slots)</span>
            </div>
            <div class="participants-grid">
                <div class="participant-slot" id="participant1">
                    <div class="participant-placeholder">
                        <i class="fas fa-user-plus"></i>
                        <span>Empty Slot</span>
                    </div>
                </div>
                <div class="participant-slot" id="participant2">
                    <div class="participant-placeholder">
                        <i class="fas fa-user-plus"></i>
                        <span>Empty Slot</span>
                    </div>
                </div>
                <div class="participant-slot" id="participant3">
                    <div class="participant-placeholder">
                        <i class="fas fa-user-plus"></i>
                        <span>Empty Slot</span>
                    </div>
                </div>
                <div class="participant-slot" id="participant4">
                    <div class="participant-placeholder">
                        <i class="fas fa-user-plus"></i>
                        <span>Empty Slot</span>
                    </div>
                </div>
                <div class="participant-slot" id="participant5">
                    <div class="participant-placeholder">
                        <i class="fas fa-user-plus"></i>
                        <span>Empty Slot</span>
                    </div>
                </div>
                <div class="participant-slot" id="participant6">
                    <div class="participant-placeholder">
                        <i class="fas fa-user-plus"></i>
                        <span>Empty Slot</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let localStream = null;
        let isStreaming = false;
        let isMicOn = false;
        let isCameraOn = false;
        let currentTheme = 'default';
        let currentFacingMode = 'user'; // 'user' for front camera, 'environment' for back camera

        // Initialize the pub stream
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved theme
            const savedTheme = localStorage.getItem('pubTheme') || 'default';
            setTheme(savedTheme, true);
            
            // Initialize stream
            initializePubStream();
            
            // Mobile device detection and setup
            if (/Mobi|Android/i.test(navigator.userAgent)) {
                console.log('Mobile device detected');
                
                // Add mobile-specific instructions
                setTimeout(() => {
                    addChatMessage('System', 'Mobile detected! Use the camera switch button to toggle between front/back cameras when your camera is on.', true);
                }, 3000);
                
                // Add mobile tips button
                setTimeout(() => {
                    addMobileTipsButton();
                }, 5000);
                
                // Ensure video element has proper mobile attributes
                const hostVideo = document.getElementById('hostVideo');
                hostVideo.setAttribute('playsinline', 'true');
                hostVideo.setAttribute('webkit-playsinline', 'true');
            }
        });

        function initializeTheme() {
            // Set default theme or load saved theme
            const savedTheme = localStorage.getItem('pubTheme') || 'default';
            setTheme(savedTheme, true); // true = silent initialization
        }

        function setTheme(theme, silent = false) {
            // Remove all theme classes
            document.body.classList.remove('cyberpunk', 'medieval', 'beach');
            
            // Remove active class from all theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Apply new theme
            if (theme !== 'default') {
                document.body.classList.add(theme);
            }
            
            // Set active button
            const activeBtn = Array.from(document.querySelectorAll('.theme-btn')).find(btn => 
                btn.textContent.toLowerCase().includes(theme) || 
                (theme === 'default' && btn.textContent === 'Default')
            );
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Update pub name and description based on theme
            const pubName = document.getElementById('pubName');
            const pubDescription = document.getElementById('pubDescription');
            
            const themeData = {
                'default': {
                    name: 'My Cozy Pub',
                    description: 'Welcome to our virtual pub! Grab a drink and chat.',
                    displayName: 'Default'
                },
                'cyberpunk': {
                    name: 'Neon Nexus Bar',
                    description: 'Welcome to the future! Jack in and connect with fellow netrunners.',
                    displayName: 'Cyberpunk'
                },
                'medieval': {
                    name: 'The Dragon\'s Tavern',
                    description: 'Gather \'round the hearth, brave adventurers! Share tales of your quests.',
                    displayName: 'Medieval'
                },
                'beach': {
                    name: 'Paradise Tiki Bar',
                    description: 'Aloha! Relax with tropical drinks and ocean vibes. 🌺🏖️',
                    displayName: 'Beach Bar'
                }
            };
            
            const currentThemeData = themeData[theme];
            pubName.textContent = currentThemeData.name;
            pubDescription.textContent = currentThemeData.description;
            
            currentTheme = theme;
            
            // Save theme preference
            localStorage.setItem('pubTheme', theme);
            
            // Add theme change message to chat (only if not silent initialization)
            if (!silent) {
                addChatMessage('System', `Pub theme changed to ${currentThemeData.displayName}! Welcome to ${currentThemeData.name}!`, true);
            }
            
            console.log(`Theme changed to: ${theme}`);
        }

        async function initializePubStream() {
            try {
                // Mobile-friendly camera constraints
                const constraints = {
                    video: {
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, max: 60 },
                        facingMode: 'user' // Front camera by default on mobile
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                };

                console.log('Requesting media devices with mobile-friendly constraints...');
                
                // Request camera and microphone permissions
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                console.log('Media stream obtained successfully');
                console.log('Video tracks:', localStream.getVideoTracks());
                console.log('Audio tracks:', localStream.getAudioTracks());
                
                // Initially turn off camera and mic
                localStream.getVideoTracks().forEach(track => {
                    track.enabled = false;
                    console.log('Video track settings:', track.getSettings());
                });
                localStream.getAudioTracks().forEach(track => track.enabled = false);
                
            } catch (error) {
                console.error('Error accessing media devices:', error);
                
                // Try fallback constraints for older mobile devices
                try {
                    console.log('Trying fallback constraints...');
                    const fallbackConstraints = {
                        video: {
                            facingMode: 'user',
                            width: { min: 320, ideal: 640, max: 1280 },
                            height: { min: 240, ideal: 480, max: 720 }
                        },
                        audio: true
                    };
                    
                    localStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                    console.log('Fallback media stream obtained successfully');
                    
                    // Initially turn off camera and mic
                    localStream.getVideoTracks().forEach(track => track.enabled = false);
                    localStream.getAudioTracks().forEach(track => track.enabled = false);
                    
                } catch (fallbackError) {
                    console.error('Fallback also failed:', fallbackError);
                    
                    // Try basic constraints as last resort
                    try {
                        console.log('Trying basic constraints...');
                        localStream = await navigator.mediaDevices.getUserMedia({
                            video: true,
                            audio: true
                        });
                        console.log('Basic media stream obtained successfully');
                        
                        // Initially turn off camera and mic
                        localStream.getVideoTracks().forEach(track => track.enabled = false);
                        localStream.getAudioTracks().forEach(track => track.enabled = false);
                        
                    } catch (basicError) {
                        console.error('All attempts failed:', basicError);
                        showError('Unable to access camera/microphone. Please check permissions and try refreshing the page.');
                        
                        // Show detailed error message for mobile users
                        if (/Mobi|Android/i.test(navigator.userAgent)) {
                            showError('Mobile tip: Make sure to allow camera access when prompted, and try using Chrome or Safari.');
                        }
                    }
                }
            }
        }

        function toggleMic() {
            const micBtn = document.getElementById('micBtn');
            const micIcon = micBtn.querySelector('i');
            
            if (localStream) {
                isMicOn = !isMicOn;
                localStream.getAudioTracks().forEach(track => track.enabled = isMicOn);
                
                if (isMicOn) {
                    micBtn.classList.add('active');
                    micIcon.className = 'fas fa-microphone';
                } else {
                    micBtn.classList.remove('active');
                    micIcon.className = 'fas fa-microphone-slash';
                }
            }
        }

        async function switchCamera() {
            if (!localStream) {
                showError('No camera stream available');
                return;
            }

            try {
                // Stop current video tracks
                localStream.getVideoTracks().forEach(track => track.stop());
                
                // Switch facing mode
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                
                console.log(`Switching to ${currentFacingMode} camera...`);
                
                // Get new video stream with switched camera
                const newVideoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, max: 60 }
                    }
                });
                
                // Replace video track in existing stream
                const newVideoTrack = newVideoStream.getVideoTracks()[0];
                const audioTracks = localStream.getAudioTracks();
                
                // Create new stream with new video track and existing audio
                localStream = new MediaStream([newVideoTrack, ...audioTracks]);
                
                // Update video element if camera is on
                if (isCameraOn) {
                    const hostVideo = document.getElementById('hostVideo');
                    hostVideo.srcObject = localStream;
                }
                
                // Update switch button text
                const switchBtn = document.getElementById('switchCameraBtn');
                if (switchBtn) {
                    switchBtn.innerHTML = `<i class="fas fa-sync-alt"></i><span>${currentFacingMode === 'user' ? 'Back Cam' : 'Front Cam'}</span>`;
                }
                
                console.log('Camera switched successfully');
                
            } catch (error) {
                console.error('Error switching camera:', error);
                showError('Unable to switch camera. This device may only have one camera.');
                
                // Revert facing mode if switch failed
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            }
        }

        function toggleCamera() {
            const cameraBtn = document.getElementById('cameraBtn');
            const cameraIcon = cameraBtn.querySelector('i');
            const hostVideo = document.getElementById('hostVideo');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            
            if (localStream) {
                isCameraOn = !isCameraOn;
                localStream.getVideoTracks().forEach(track => track.enabled = isCameraOn);
                
                if (isCameraOn) {
                    cameraBtn.classList.add('active');
                    cameraIcon.className = 'fas fa-video';
                    hostVideo.srcObject = localStream;
                    hostVideo.style.display = 'block';
                    videoPlaceholder.style.display = 'none';
                    
                    // Show camera switch button on mobile
                    const switchBtn = document.getElementById('switchCameraBtn');
                    if (switchBtn && /Mobi|Android/i.test(navigator.userAgent)) {
                        switchBtn.style.display = 'flex';
                    }
                } else {
                    cameraBtn.classList.remove('active');
                    cameraIcon.className = 'fas fa-video-slash';
                    hostVideo.style.display = 'none';
                    videoPlaceholder.style.display = 'flex';
                    videoPlaceholder.innerHTML = `
                        <i class="fas fa-video-slash"></i>
                        <h3>Camera Off</h3>
                        <p>Click "Camera" to start your video stream</p>
                    `;
                    
                    // Hide camera switch button when camera is off
                    const switchBtn = document.getElementById('switchCameraBtn');
                    if (switchBtn) {
                        switchBtn.style.display = 'none';
                    }
                }
            } else {
                showError('Camera not available. Please refresh the page and allow camera access.');
            }
        }

        function startStream() {
            const startBtn = document.getElementById('startStreamBtn');
            const liveIndicator = document.getElementById('liveIndicator');
            
            if (!isStreaming) {
                isStreaming = true;
                startBtn.innerHTML = '<i class="fas fa-stop"></i><span>Stop Stream</span>';
                startBtn.classList.add('danger');
                liveIndicator.classList.add('active');
                
                // Add system message
                addChatMessage('System', 'Pub stream is now live!', true);
                
                console.log('Stream started');
            } else {
                isStreaming = false;
                startBtn.innerHTML = '<i class="fas fa-broadcast-tower"></i><span>Start Stream</span>';
                startBtn.classList.remove('danger');
                liveIndicator.classList.remove('active');
                
                // Add system message
                addChatMessage('System', 'Pub stream has ended.', true);
                
                console.log('Stream stopped');
            }
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message) {
                addChatMessage('You', message);
                chatInput.value = '';
            }
        }

        function addChatMessage(author, text, isSystem = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-author" style="${isSystem ? 'color: #4299e1;' : ''}">${author}</div>
                <div class="message-text">${text}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function leavePub() {
            if (confirm('Are you sure you want to leave the pub?')) {
                // Clean up streams
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                
                // Redirect back to pub list
                window.location.href = 'pub.html';
            }
        }

        function showError(message) {
            addChatMessage('System', `Error: ${message}`, true);
        }

        function showMobileCameraTips() {
            const tips = [
                "📱 Mobile Camera Tips:",
                "• Make sure to allow camera access when prompted",
                "• Try refreshing the page if camera doesn't work",
                "• Use Chrome or Safari for best compatibility",
                "• Check if another app is using your camera",
                "• Try switching between front/back cameras",
                "• Ensure you have good lighting for better quality"
            ];
            
            tips.forEach((tip, index) => {
                setTimeout(() => {
                    addChatMessage('System', tip, true);
                }, index * 1000);
            });
        }

        // Add mobile camera tips button for troubleshooting
        function addMobileTipsButton() {
            if (/Mobi|Android/i.test(navigator.userAgent)) {
                const chatMessages = document.getElementById('chatMessages');
                const tipsButton = document.createElement('div');
                tipsButton.className = 'chat-message';
                tipsButton.style.cursor = 'pointer';
                tipsButton.style.background = 'rgba(66, 153, 225, 0.2)';
                tipsButton.style.border = '1px solid #4299e1';
                tipsButton.onclick = showMobileCameraTips;
                
                tipsButton.innerHTML = `
                    <div class="message-author" style="color: #4299e1;">System</div>
                    <div class="message-text">📱 Having camera issues? Click here for mobile tips!</div>
                    <div class="message-time">Help</div>
                `;
                
                chatMessages.appendChild(tipsButton);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Handle Enter key in chat input
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Simulate some activity for demo
        setTimeout(() => {
            addChatMessage('System', 'Welcome to your pub! Others can join by clicking on your pub from the main page.', true);
        }, 2000);
    </script>
</body>
</html> 